{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Cloudformation stack for v2x-restreamer-fargate on ECS, cosumes user pushed registry",
  
    "Parameters": {
        "LaunchType": {
            "Description" : "Select Launch Type EC2 or Fargate",
            "Type": "String", 
            "Default": "Fargate", 
            "AllowedValues": [
                "Fargate"
            ]
        },
        "RestreamerImage": {
            "Description" : "Restreamer Image in ECR",
            "Type": "String", 
            "Default": "431307104808.dkr.ecr.us-east-1.amazonaws.com/demoperlcontainer:latest"
        },
        "ContainerPort":{
            "Description" : "Restreamer Image in ECR",
            "Type": "String", 
            "Default": "8888"
        },
        "DesiredCount": {
            "Description" : "Desired number of services",
            "Type": "Number", 
            "Default": 3
        }, 
        "InstanceType": {
            "Description" : "Enter the instance type",
            "Type": "String", 
            "Default": "t2.large"
        }, 
        "ClusterSize": {
            "Description" : "Enter the cluster size",
            "Type": "Number", 
            "Default": 2
        }, 
        "Subnets": {
            "Description" : "Select the subnets",
            "Type": "List<AWS::EC2::Subnet::Id>"
        }, 
        "SourceSecurityGroup": {
            "Description" : "Select the security group",
            "Type": "AWS::EC2::SecurityGroup::Id"
        }, 
        "VpcId": {
            "Description" : "Select the VPC",
            "Type": "AWS::EC2::VPC::Id"
        },
        "v2xECSIAMTaskExecutionRole" : {
          "Description" : "Name of an existing IAMRole for AmazonEC2ContainerServiceforEC2Role",
          "Type": "String",
          "Default" : "ecsTaskExecutionRole",
          "ConstraintDescription" : "must be the name of an existing role."
        },
        "v2xfargateKinesisIAMRole" : {
          "Description" : "Name of an existing IAMRole for kinesis",
          "Type": "String",
          "Default" : "fargateKinesis",
          "ConstraintDescription" : "must be the name of an existing kinesis role."
        }
    },
    "Conditions": {
        "Fargate": {
            "Fn::Equals": [
                {
                    "Ref": "LaunchType"
                }, 
                "Fargate"
            ]
        }, 
        "EC2": {
            "Fn::Equals": [
                {
                    "Ref": "LaunchType"
                }, 
                "EC2"
            ]
        }
    }, 

    "Mappings": {
        "AWSRegionToAMI": {
            "ap-south-1": {
                "AMI": "ami-00491f6f"
            }, 
            "eu-west-3": {
                "AMI": "ami-9aef59e7"
            }, 
            "eu-west-2": {
                "AMI": "ami-67cbd003"
            }, 
            "eu-west-1": {
                "AMI": "ami-1d46df64"
            }, 
            "ap-northeast-2": {
                "AMI": "ami-c212b2ac"
            }, 
            "ap-northeast-1": {
                "AMI": "ami-872c4ae1"
            }, 
            "sa-east-1": {
                "AMI": "ami-af521fc3"
            }, 
            "ca-central-1": {
                "AMI": "ami-435bde27"
            }, 
            "ap-southeast-1": {
                "AMI": "ami-910d72ed"
            }, 
            "ap-southeast-2": {
                "AMI": "ami-58bb443a"
            }, 
            "eu-central-1": {
                "AMI": "ami-509a053f"
            }, 
            "us-east-1": {
                "AMI": "ami-28456852"
            }, 
            "us-east-2": {
                "AMI": "ami-ce1c36ab"
            }, 
            "us-west-1": {
                "AMI": "ami-74262414"
            }, 
            "us-west-2": {
                "AMI": "ami-decc7fa6"
            }
        }
    }, 
    "Resources": {
       "LogGroup": {
            "Type": "AWS::Logs::LogGroup", 
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/ecs/${AWS::StackName}"
                }
            }
        },
        "Cluster": {
            "Type": "AWS::ECS::Cluster", 
            "Properties": {
                "ClusterName": {
                    "Ref": "AWS::StackName"
                }
            }
        }, 
        "TaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition", 
            "Properties": {
                "RequiresCompatibilities": [
                    {
                        "Fn::If": [
                            "Fargate", 
                            "FARGATE", 
                            "EC2"
                        ]
                    }
                ], 
                "Memory": 512, 
                "Cpu": 256, 
                "NetworkMode": {
                    "Fn::If": [
                        "Fargate", 
                        "awsvpc", 
                        "bridge"
                    ]
                }, 
                "ExecutionRoleArn": {
                    "Ref": "v2xECSIAMTaskExecutionRole"
                }, 
                "TaskRoleArn": {
                    "Ref": "v2xfargateKinesisIAMRole"
                },
                "ContainerDefinitions": [
                    {           
                    "Name": {
                        "Fn::Sub": "${AWS::StackName}-container"
                    }, 
                    "Essential": true, 
                    "Image": {
                        "Ref": "RestreamerImage"
                    }, 
                    "Environment": [
                        {
                          "Name" : "RESTREAMER_DATADOGAPIKEY",
                          "Value" : "none" 
                        }, 
                        {
                          "Name" : "RESTREAMER_DATADOGENVIRONMENT",
                          "Value" : "none" 
                        },
                        {
                          "Name" : "RESTREAMER_KINESISNAME",
                          "Value" : "bsms"
                        },
                        {
                          "Name" : "RESTREAMER_PORT",
                          "Value": "8888"
                        }
                    ],
                    "PortMappings": [
                        {
                        "ContainerPort": 8888,
                        "HostPort": 8888,
                        "Protocol": "tcp"
                      },
                      {
                        "ContainerPort": 8081,
                        "HostPort": 8081,
                        "Protocol": "udp"
                      }
                    ],
                    "LogConfiguration": {
                        "LogDriver": "awslogs", 
                        "Options": {
                            "awslogs-group": {
                                "Ref": "LogGroup"
                            }, 
                            "awslogs-region": {
                                "Ref": "AWS::Region"
                            }, 
                            "awslogs-stream-prefix": {
                                "Ref": "AWS::StackName"
                            }
                        }
                    }
                }
              ]
            }
        },
        "FargateService": {
            "Type": "AWS::ECS::Service", 
            "Condition": "Fargate", 
            "Properties": {
                "Cluster": {
                    "Ref": "Cluster"
                }, 
                "DesiredCount": {
                    "Ref": "DesiredCount"
                }, 
                "TaskDefinition": {
                    "Ref": "TaskDefinition"
                }, 
                "LaunchType": "FARGATE", 
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "ENABLED", 
                        "SecurityGroups": [
                            {
                                "Ref": "SourceSecurityGroup"
                            }
                        ], 
                        "Subnets": {
                            "Ref": "Subnets"
                        }
                    }
                }
            }
        }
    }, 
    "Outputs": {
        "ClusterName": {
            "Value": {
                "Ref": "Cluster"
            }
        },        
        "Service": {
            "Value": {
                 "Ref": "FargateService"
                    }
            }  
    }
}